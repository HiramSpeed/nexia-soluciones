{% load custom_filters %}
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='utf-8' />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Áreas Comunes</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #1a202c; }
        h1, h2, h3 { font-family: 'Jura', sans-serif; }
        
        /* Dark mode calendar styling */
        .fc { background-color: #2d3748; color: #e2e8f0; }
        .fc .fc-button-primary { background-color: #4299e1; border-color: #4299e1; }
        .fc .fc-button-primary:hover { background-color: #3182ce; }
        .fc .fc-toolbar-title { font-size: 1.25rem; color: #e2e8f0; }
        .fc-theme-standard td, .fc-theme-standard th { border-color: #4a5568; }
        .fc-daygrid-day-number { color: #cbd5e0; }
        .fc-col-header-cell-cushion { color: #a0aec0; }
        .fc-daygrid-day.fc-day-today { background-color: rgba(66, 153, 225, 0.1) !important; }
        
        /* List view date headers - make bold and visible */
        .fc-list-day-cushion { font-weight: 700 !important; color: #1a202c !important; font-size: 1.1rem !important; }
        .fc-list-event-time { color: #cbd5e0; }
        .fc-list-event-title { color: #e2e8f0; }
        .fc-list-day-frame { background-color: #2d3748 !important; }
        .fc-list-table { background-color: #2d3748 !important; }
        .fc-list-event { background-color: #374151 !important; border-color: #4b5563 !important; }
        .fc-list-event:hover { background-color: #4b5563 !important; }
    </style>
</head>
<body class="bg-gray-900">

    <div class="w-full max-w-7xl mx-auto p-4 md:p-8">
        {% include 'condominio/_header_villa.html' %}

        <div class="bg-gray-800 p-4 sm:p-6 md:p-8 rounded-xl shadow-lg mt-8 border border-gray-700">
            <a href="{% url 'condominio:dashboard' %}" class="inline-block mb-6 font-semibold text-blue-400 hover:text-blue-300">&larr; Volver al Panel Principal</a>
            <h1 class="text-3xl font-bold text-gray-100 mb-2">Calendario de Áreas Comunes</h1>

            {% if messages %}
                <ul class="my-4">
                {% for message in messages %}
                    <li class="p-4 mb-2 rounded-lg text-sm font-medium {% if message.tags == 'success' %}bg-green-900/50 text-green-200 border border-green-700{% else %}bg-red-900/50 text-red-200 border border-red-700{% endif %}">
                        {{ message }}
                    </li>
                {% endfor %}
                </ul>
            {% endif %}

            {% if form %}
                <p class="text-gray-300 mb-8">Haz clic en un día para solicitar una reservación.</p>
            {% else %}
                 <p class="text-gray-300 mb-8">Revisa las fechas ocupadas. Para reservar, asegúrate de no tener adeudos pendientes.</p>
            {% endif %}

            <div id='calendar'></div>
        </div>
    </div>

    <div id="bookingModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md relative border border-gray-700">
            <button id="closeButton" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200">
                <span class="sr-only">Cerrar</span>
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-100 mb-6">Solicitar Reservación</h2>

            {% if form %}
                <form method="post" id="djangoForm" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="fecha_hora_inicio" id="id_fecha_hora_inicio">
                    <input type="hidden" name="fecha_hora_fin" id="id_fecha_hora_fin">

                    <div>
                        <label for="id_area_comun" class="block text-sm font-medium text-gray-300 mb-1">{{ form.area_comun.label }}</label>
                        {{ form.area_comun|add_class:"mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-200" }}
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="id_hora_inicio" class="block text-sm font-medium text-gray-300 mb-1">Hora de Inicio:</label>
                            <select id="id_hora_inicio" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-200">
                                <option value="">--:--</option>
                                {% for hora in horas_disponibles %}<option value="{{ hora }}">{{ hora }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="id_duracion" class="block text-sm font-medium text-gray-300 mb-1">Duración:</label>
                            <select id="id_duracion" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-200">
                                <option value="1">1 hora</option>
                                <option value="2">2 horas</option>
                                <option value="3">3 horas</option>
                            </select>
                        </div>
                    </div>

                    <div id="group-cantidad-personas" class="hidden">
                        <label for="id_cantidad_personas" class="block text-sm font-medium text-gray-300 mb-1">{{ form.cantidad_personas.label }}</label>
                        {{ form.cantidad_personas|add_class:"mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-200" }}
                    </div>

                    <div id="reglas-alberca" class="hidden space-y-3 p-4 bg-blue-900/30 rounded-lg border border-blue-700">
                        <h4 class="font-bold text-gray-100">Reglas de la Alberca</h4>
                        <ul class="list-disc list-inside text-sm text-gray-300 space-y-1">
                            <li>Usar traje de baño (sin ropa interior/algodón).</li>
                            <li>No se permiten bebidas o comida dentro de la alberca.</li>
                            <li>Niños siempre deben estar acompañados por un adulto.</li>
                        </ul>
                        <div class="flex items-center">
                            {{ form.acepta_reglas|add_class:"h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" }}
                            <label for="{{ form.acepta_reglas.id_for_label }}" class="ml-2 block text-sm text-gray-200">{{ form.acepta_reglas.label }}</label>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3 px-4 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors">Enviar Solicitud</button>
                </form>
            {% endif %}
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            list:  'Lista'
        },
        events: "{% url 'condominio:reservaciones_feed' %}",

        dateClick: function(info) {
            {% if form %}
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (info.date < today) {
                    alert("No puedes seleccionar una fecha en el pasado.");
                    return;
                }

                document.getElementById('modalTitle').innerText = `Reservar para el ${info.date.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}`;
                const formEl = document.getElementById('djangoForm');
                const selectedDate = info.dateStr;
                const horaInicioSelect = document.getElementById('id_hora_inicio');
                const duracionSelect = document.getElementById('id_duracion');

                // ... dentro de tu script, justo después de la línea "dateClick: function(info) {"

          formEl.onsubmit = function(e) {
              const horaInicio = horaInicioSelect.value;
              if (!horaInicio) {
                  alert('Por favor, selecciona una hora de inicio.');
                  e.preventDefault();
                  return false;
              }

              // Creamos el objeto de fecha de inicio. El navegador lo interpreta en hora local.
              const inicioDT = new Date(`${selectedDate}T${horaInicio}`);

              // Calculamos la fecha de fin sumando las horas
              const duracion = parseInt(duracionSelect.value);
              const finDT = new Date(inicioDT.getTime() + duracion * 60 * 60 * 1000);

              // --- INICIO DEL CAMBIO IMPORTANTE ---

              // Función auxiliar para formatear la fecha en formato YYYY-MM-DD HH:MM
              // usando los componentes de la hora local, no UTC.
              function formatLocalDateTime(dt) {
                  const pad = (num) => num.toString().padStart(2, '0');

                  const year = dt.getFullYear();
                  const month = pad(dt.getMonth() + 1); // getMonth() es 0-11
                  const day = pad(dt.getDate());
                  const hours = pad(dt.getHours());
                  const minutes = pad(dt.getMinutes());

                  return `${year}-${month}-${day} ${hours}:${minutes}`;
              }


              document.getElementById('id_fecha_hora_inicio').value = formatLocalDateTime(inicioDT);
              document.getElementById('id_fecha_hora_fin').value = formatLocalDateTime(finDT);


          };



                document.getElementById('bookingModal').classList.remove('hidden');
            {% endif %}
        }
    });
    calendar.render();

    // Lógica para manejar el modal
    const modal = document.getElementById('bookingModal');
    if (modal && {% if form %}true{% else %}false{% endif %}) {
        const closeButton = document.getElementById('closeButton');
        function closeModal() { modal.classList.add('hidden'); }
        closeButton.onclick = closeModal;
        modal.addEventListener('click', function(event) { if (event.target === modal) { closeModal(); } });

        const areaSelect = document.getElementById('id_area_comun');
        const reglasDiv = document.getElementById('reglas-alberca');
        const cantidadPersonasDiv = document.getElementById('group-cantidad-personas');
        const aceptaReglasInput = document.getElementById('id_acepta_reglas');

        function toggleAreaFields() {
            if (!areaSelect) return;
            const selectedOptionText = areaSelect.options[areaSelect.selectedIndex].text.toLowerCase();
            const esAlberca = selectedOptionText.includes('alberca');
            const esTerraza = selectedOptionText.includes('terraza');

            reglasDiv.style.display = esAlberca ? 'block' : 'none';
            aceptaReglasInput.required = esAlberca;

            cantidadPersonasDiv.style.display = (esAlberca || esTerraza) ? 'block' : 'none';
            document.getElementById('id_cantidad_personas').required = (esAlberca || esTerraza);
        }
        areaSelect.addEventListener('change', toggleAreaFields);
        toggleAreaFields(); // Llamar una vez al inicio para establecer el estado correcto
    }
});
</script>
</body>
</html>