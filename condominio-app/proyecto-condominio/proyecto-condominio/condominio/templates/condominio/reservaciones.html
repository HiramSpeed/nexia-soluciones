<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='utf-8' />
    <title>Calendario de Áreas Comunes</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f9f9f9; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .nav-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        #calendar { max-width: 100%; margin: 0 auto; }
        .fc-event { cursor: pointer; border: none !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; position: relative; }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal h2 { margin-top: 0; }
        .modal-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-submit { background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        #reglas-alberca { margin-top:15px; padding:10px; background-color:#eef2f7; border-radius:5px; font-size: 0.9em; }
        #reglas-alberca label { display: flex; align-items: center; margin-top: 10px; }
        #reglas-alberca input { margin-right: 10px; }
        .messages { list-style-type: none; padding: 0; margin: 0 0 20px 0; }
        .messages li.error { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; }
        .form-errors { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="main-container"></div>
    {% include 'condominio/_header_villa.html' %}

    <div class="container">
    <a href="{% url 'dashboard' %}" class="nav-link">&larr; Volver al Panel Principal</a>
    <h1>Calendario de Áreas Comunes</h1>

    {% if form %}
        <p>Haz clic en un día para solicitar una reservación.</p>
    {% endif %}

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div id='calendar'></div>
</div>

<div id="bookingModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalTitle">Solicitar Reservación</h2>
        {% if form %}
            <form method="post" id="djangoForm">
                {% csrf_token %}

                {% if form.errors %}
                    <div class="form-errors">
                        <p><strong>Por favor, corrige los siguientes errores:</strong></p>
                        {{ form.non_field_errors }}
                        {{ form.as_ul }}
                    </div>
                {% endif %}
                
                <input type="hidden" name="fecha_hora_inicio" id="id_fecha_hora_inicio">
                <input type="hidden" name="fecha_hora_fin" id="id_fecha_hora_fin">

                <div class="form-group">{{ form.area_comun.label_tag }}{{ form.area_comun }}</div>
                <div class="modal-form-row">
                    <div class="form-group">
                        <label for="id_hora_inicio">Hora de Inicio:</label>
                        <select id="id_hora_inicio" class="form-control" required>
                            <option value="">--:--</option>
                            {% for hora in horas_disponibles %}<option value="{{ hora }}">{{ hora }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_duracion">Duración:</label>
                        <select id="id_duracion" class="form-control"><option value="1">1 hora</option><option value="2">2 horas</option><option value="3">3 horas</option></select>
                    </div>
                </div>
                <div class="form-group" id="group-cantidad-personas" style="display:none;">{{ form.cantidad_personas.label_tag }}{{ form.cantidad_personas }}</div>
                <div id="reglas-alberca" style="display:none;">
                    <h4>Reglas de la Alberca</h4>
                    <ul><li>Usar traje de baño (sin ropa interior/algodón).</li><li>No se permiten bebidas o comida dentro de la alberca.</li><li>Niños siempre deben estar acompañados por un adulto.</li></ul>
                    <p><small>Infringir las reglas puede resultar en multas o suspensión del servicio.</small></p>
                    <label>{{ form.acepta_reglas }} {{ form.acepta_reglas.label }}</label>
                </div>
                <button type="submit" class="btn-submit">Enviar Solicitud</button>
            </form>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DEL CALENDARIO (con la corrección para morosos) ---
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
        events: "{% url 'reservaciones_feed' %}",
        dateClick: function(info) {
            {% if form %} // <-- CORRECCIÓN 1: Si no hay form (por morosidad), este bloque no se ejecuta
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (info.date < today) {
                    alert("No puedes seleccionar una fecha en el pasado.");
                    return;
                }
                
                // Pre-llenamos datos y mostramos el modal
                document.getElementById('modalTitle').innerText = `Reservar para el ${info.date.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}`;
                
                // CORRECCIÓN 3: Lógica para el botón de envío
                const form = document.getElementById('djangoForm');
                const selectedDate = info.dateStr; // YYYY-MM-DD
                const horaInicioSelect = document.getElementById('id_hora_inicio');
                const duracionSelect = document.getElementById('id_duracion');
                
                form.onsubmit = function() {
                    const horaInicio = horaInicioSelect.value;
                    if (!horaInicio) {
                        alert('Por favor, selecciona una hora de inicio.');
                        return false; // Detiene el envío del formulario
                    }
                    const duracion = parseInt(duracionSelect.value);
                    const inicioDT = new Date(`${selectedDate}T${horaInicio}`);
                    const finDT = new Date(inicioDT.getTime() + duracion * 60 * 60 * 1000);
                    
                    document.getElementById('id_fecha_hora_inicio').value = inicioDT.toISOString().slice(0, 16);
                    document.getElementById('id_fecha_hora_fin').value = finDT.toISOString().slice(0, 16);
                };

                document.getElementById('bookingModal').style.display = 'flex';
            {% endif %}
        }
    });
    calendar.render();

    // --- LÓGICA DEL MODAL Y CAMPOS DINÁMICOS (sin cambios) ---
    const modal = document.getElementById('bookingModal');
    if (modal) { // Solo si el modal existe
        const closeButton = modal.querySelector('.close-button');
        closeButton.onclick = function() { modal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == modal) { modal.style.display = 'none'; } }
        
        const areaSelect = document.getElementById('id_area_comun');
        const reglasDiv = document.getElementById('reglas-alberca');
        const cantidadPersonasDiv = document.querySelector('#id_cantidad_personas').parentElement;
        const aceptaReglasCheckbox = document.querySelector('#id_acepta_reglas').parentElement;

        function toggleAreaFields() {
            const selectedOption = areaSelect.options[areaSelect.selectedIndex].text.toLowerCase();
            const esAlberca = selectedOption.includes('alberca');
            const esTerraza = selectedOption.includes('terraza');
            
            reglasDiv.style.display = esAlberca ? 'block' : 'none';
            aceptaReglasCheckbox.style.display = esAlberca ? 'block' : 'none';
            document.getElementById('id_acepta_reglas').required = esAlberca;
            
            cantidadPersonasDiv.style.display = (esAlberca || esTerraza) ? 'block' : 'none';
            document.getElementById('id_cantidad_personas').required = (esAlberca || esTerraza);
        }

        areaSelect.addEventListener('change', toggleAreaFields);
        toggleAreaFields();
    }
});
</script>
</body>
</html>