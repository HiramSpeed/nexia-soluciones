{% extends 'condominio/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<style>
    .flatpickr-calendar {
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border: none;
    }

    .flatpickr-day.selected {
        background: #2563eb;
        border-color: #2563eb;
    }

    /* Azul Tailwind */
</style>

<main class="max-w-3xl mx-auto p-4 md:p-8">

    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-100">Estacionamiento</h1>
        <a href="{% url 'condominio:dashboard' %}"
            class="flex items-center text-blue-400 hover:text-blue-300 font-medium transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
                </path>
            </svg>
            Volver al Dashboard
        </a>
    </div>

    <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden">

        <div class="bg-gray-750 px-6 py-5 border-b border-gray-700 flex items-center gap-3">
            <div class="p-2 bg-blue-900/30 rounded-lg text-blue-400">
                <i class="fas fa-parking fa-lg"></i>
            </div>
            <div>
                <h2 class="text-lg font-bold text-gray-100">Nueva Reserva</h2>
                <p class="text-sm text-gray-400">Solicita un espacio temporalmente</p>
            </div>
        </div>

        <div class="p-6 md:p-8">

            <div class="mb-8 bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-blue-300">Reglas de Asignación:</h3>
                        <ul class="mt-2 list-disc list-inside text-sm text-blue-200 space-y-1">
                            <li>El sistema buscará primero disponibilidad en <strong>cajones de
                                    visitas/públicos</strong>.</li>
                            <li>Si están llenos, buscará disponibilidad en cajones <strong>privados prestados</strong>
                                por otros vecinos.</li>
                            <li><strong>Solo si todos los lugares están ocupados</strong>, no se podrá realizar la
                                reserva adicional.</li>
                            <li>Si la reserva dura más de <strong>24 horas</strong>, quedará pendiente de aprobación.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <form method="post" id="reservaForm" class="space-y-6">
                {% csrf_token %}

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                        {{ form.vehiculo.label }}
                    </label>
                    <div class="relative">
                        {{ form.vehiculo|add_class:"block w-full pl-3 pr-10 py-3 border border-gray-600
                        focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg shadow-sm
                        bg-gray-700 text-gray-200 cursor-pointer" }}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">
                            Fecha y Hora de Inicio
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-calendar-alt text-gray-500"></i>
                            </div>
                            {{ form.fecha_inicio|add_class:"datetime-picker block w-full pl-10 px-4 py-3 border
                            border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700
                            text-gray-200" }}
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">
                            Fecha y Hora de Fin
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-flag-checkered text-gray-500"></i>
                            </div>
                            {{ form.fecha_fin|add_class:"datetime-picker block w-full pl-10 px-4 py-3 border
                            border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700
                            text-gray-200" }}
                        </div>
                    </div>
                </div>

                {% if form.non_field_errors %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    {% for error in form.non_field_errors %}
                    <p class="text-sm text-red-600 font-medium">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="pt-6 flex flex-col md:flex-row gap-4">
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-all">
                        Confirmar Reserva
                    </button>
                    <a href="{% url 'condominio:dashboard' %}"
                        class="flex-1 bg-gray-700 text-gray-200 font-bold py-3 px-4 rounded-lg border border-gray-600 hover:bg-gray-600 text-center">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configuración común
        const config = {
            enableTime: true,
            dateFormat: "Y-m-d H:i", // Formato para Django
            altInput: true,          // Mostrar formato amigable al usuario
            altFormat: "F j, Y - h:i K", // Ej: Diciembre 5, 2025 - 3:00 PM
            locale: "es",            // Idioma Español
            time_24hr: false,
            minDate: "today",
            disableMobile: "true"    // Forzar el est ilo bonito incluso en móvil
        };

        // Inicializar Inicio
        const fpInicio = flatpickr("#{{ form.fecha_inicio.auto_id }}", {
            ...config,
            onChange: function (selectedDates, dateStr, instance) {
                // Al elegir inicio, actualizar el mínimo de la fecha fin
                fpFin.set('minDate', dateStr);

                // Sugerir automáticamente 2 horas después si está vacío
                if (!fpFin.selectedDates.length) {
                    const suggestedEnd = new Date(selectedDates[0].getTime() + 2 * 60 * 60 * 1000);
                    fpFin.setDate(suggestedEnd);
                }
            }
        });

        // Inicializar Fin
        const fpFin = flatpickr("#{{ form.fecha_fin.auto_id }}", config);
    });
</script>
{% endblock %}